<!DOCTYPE html>
<!-- From https://github.com/snkeos/client-state-redirector -->
<!--
	Keycloak uses https://openid.net/specs/openid-connect-rpinitiated-1_0.html#RPLogout
	AWS Cognito does not support that - https://docs.aws.amazon.com/cognito/latest/developerguide/logout-endpoint.html .
	Solution: this page.
	Configure this page in Keycloak as logout URL for the Cogntio IDP. It will save state in a cookie.
	Configure this page in Cognito as logout_uri. It will redirect to Keycloak with the state from the saved cookie.

	Cognito logout example:
	GET https://mydomain.auth.us-east-1.amazoncognito.com/logout?client_id=X&logout_uri=https://myclient/logout

	Keycloak logout sample:
	https://mycognito.example.com/logout?client_id=...&logout_uri=https://mykeycloak.example.com/auth/realms/cdh/broker/oidc/endpoint&state=50bafe45-da83-40f9-9c66-3e19da3b338a&id_token_hint=...&post_logout_redirect_uri=https://mykeycloak.example.com/auth/realms/cdh/broker/oidc/endpoint/logout_response

-->
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<title>Redirecting</title>
	</head>
	<body>
		<h1>Redirecting</h1>
		<p id="req-js">This page requires JavaScript</p>
		<p id="error" hidden="hidden" style="color: red"></p>
		<script>

			var reqJS = document.getElementById('req-js');
			reqJS.hidden = true;

			function die(message) {
				var e = document.getElementById('error');
				e.innerText = message;
				e.hidden = false;
				throw new Error(message);
			}

			try {
				var url = new URL(window.location.href);
				var cognitoUrl = url.searchParams.get('cognito_url');
				var storage = window.localStorage;

				if(cognitoUrl) {
					var SAVE_PARAMS = ['post_logout_redirect_uri', 'state'];

					// phase 1: Keycloak -> this page -> Cognito

					SAVE_PARAMS.forEach(function (paramName) {
						var paramValue = url.searchParams.get(paramName);
						if(!paramValue) {
							die(paramName + ' parameter is missing');
						}
						storage.setItem(paramName, paramValue);
					});

					cognitoUrl = new URL(cognitoUrl);
					// Restrict to http and https protocols (avoid javascript:)
					if(!['http:', 'https:'].includes(dst.protocol)) {
						die('cognito_url is not a valid url');
					}
					cognitoUrl.searchParams.set('logout_uri', window.location.href.split('?')[0]);

					// For local testing:
					// cognitoUrl.searchParams.set('logout_uri', 'https://127.0.0.1:8000/index.html');

					window.location = cognitoUrl.toString();

				} else {
					// phase 2: Cognito -> this page -> Keycloak

					var postLogoutRedirectUri = storage.getItem('post_logout_redirect_uri');
					if(!postLogoutRedirectUri) {
						die('post_logout_redirect_uri was not found in local storage');
					}

					var state = storage.getItem('state');
					if(!state) {
						die('state was not found in local storage');
					}

					var dst = new URL(postLogoutRedirectUri);
					// Restrict to http and https protocols (avoid javascript:)
					if(!['http:', 'https:'].includes(dst.protocol)) {
						die('post_logout_redirect_uri is not a valid url');
					}
					dst.searchParams.set('state', state);

					window.location = dst.toString();
				}
			} catch(err) {
				die(err.message);
			}
		</script>
	</body>
</html>
